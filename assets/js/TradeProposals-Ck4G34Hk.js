var e=Object.defineProperty,s=(e,s,r)=>new Promise((t,a)=>{var i=e=>{try{c(r.next(e))}catch(s){a(s)}},o=e=>{try{c(r.throw(e))}catch(s){a(s)}},c=e=>e.done?t(e.value):Promise.resolve(e.value).then(i,o);c((r=r.apply(e,s)).next())});import{r,j as t,z as a,k as i,F as o,ah as c,a1 as n,a8 as d,K as l}from"./react-vendor-CnY34O61.js";import{L as u}from"./Layout-BPnBhQSp.js";import{s as h,u as m,t as p,C as f,c as x,a as v,b as j,f as g,d as y,B as N}from"./index-BBu7AVS9.js";import{T as _,a as w,b,c as q}from"./tabs-aRayiNj8.js";import{D as O,a as S,b as C,c as R,d as M,T as P,e as I}from"./textarea-Db-_GloC.js";import{I as D}from"./input-DGNBd0ih.js";import{t as T}from"./timeCredits-C7U4qTHB.js";import{m as E}from"./matchingEngine-Bob_s50X.js";import{f as F}from"./utils-vendor-BkyaMd0J.js";import"./vendor-CwuJVHC1.js";import"./backend-vendor-CggdsxVJ.js";import"./ui-vendor-CttiZxwU.js";import"./query-vendor-DEKS82BJ.js";const W=class e{static getInstance(){return e.instance||(e.instance=new e),e.instance}createProposal(e,r,t,a,i){return s(this,null,function*(){try{const{data:s,error:o}=yield h.from("services").select("*").eq("id",t).single(),{data:c,error:n}=yield h.from("services").select("*").eq("id",a).single();if(o||n||!s||!c)return{success:!1,error:"Service not found"};const d=T.calculateCredits(i.hoursOffered,s.category),l=T.calculateCredits(i.hoursRequested,c.category),u=T.calculateExchangeRate(s.category,c.category),m={proposer_id:e,provider_id:r,service_offered_id:t,service_requested_id:a,hours_offered:i.hoursOffered,hours_requested:i.hoursRequested,status:"pending"},{data:p,error:f}=yield h.from("trades").insert(m).select().single();if(f)throw f;const x={id:p.id,proposerId:e,providerId:r,proposerServiceId:t,providerServiceId:a,hoursOffered:i.hoursOffered,hoursRequested:i.hoursRequested,creditsOffered:d,creditsRequested:l,exchangeRate:u,status:"pending",message:i.message,urgency:i.urgency||"medium",estimatedCompletionDays:i.estimatedCompletionDays||7,deliverables:i.deliverables||[],createdAt:new Date(p.created_at),updatedAt:new Date(p.updated_at),expiresAt:new Date(Date.now()+6048e5)};return yield this.sendProposalNotification(r,x),{success:!0,proposal:x}}catch(s){return{success:!1,error:s instanceof Error?s.message:"Failed to create proposal"}}})}getUserProposals(e){return s(this,null,function*(){try{const{data:s,error:r}=yield h.from("trades").select("\n          *,\n          service_offered:service_offered_id(*),\n          service_requested:service_requested_id(*),\n          proposer:proposer_id(display_name, avatar_url),\n          provider:provider_id(display_name, avatar_url)\n        ").or(`proposer_id.eq.${e},provider_id.eq.${e}`).order("created_at",{ascending:!1});if(r)throw r;const t=[],a=[];for(const i of s||[]){const s=yield this.convertTradeToProposal(i);i.proposer_id===e?t.push(s):a.push(s)}return{sent:t,received:a}}catch(s){return{sent:[],received:[],error:s instanceof Error?s.message:"Failed to get proposals"}}})}acceptProposal(e,r){return s(this,null,function*(){try{const{error:s}=yield h.from("trades").update({status:"active",updated_at:(new Date).toISOString()}).eq("id",e).eq("provider_id",r);if(s)throw s;return{success:!0}}catch(s){return{success:!1,error:s instanceof Error?s.message:"Failed to accept proposal"}}})}rejectProposal(e,r,t){return s(this,null,function*(){try{const{error:s}=yield h.from("trades").update({status:"cancelled",cancelled_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}).eq("id",e).eq("provider_id",r);if(s)throw s;return{success:!0}}catch(s){return{success:!1,error:s instanceof Error?s.message:"Failed to reject proposal"}}})}createCounterOffer(e,r,t){return s(this,null,function*(){try{const{data:s,error:r}=yield h.from("trades").select("*").eq("id",e).single();if(r||!s)return{success:!1,error:"Original proposal not found"};const a={proposer_id:s.provider_id,provider_id:s.proposer_id,service_offered_id:s.service_requested_id,service_requested_id:s.service_offered_id,hours_offered:t.newHoursOffered||s.hours_requested,hours_requested:t.newHoursRequested||s.hours_offered,status:"pending"},{data:i,error:o}=yield h.from("trades").insert(a).select().single();if(o)throw o;return yield h.from("trades").update({status:"cancelled"}).eq("id",e),{success:!0}}catch(s){return{success:!1,error:s instanceof Error?s.message:"Failed to create counter-offer"}}})}getTradeRecommendations(e){return s(this,null,function*(){try{const s=yield E.getMatchesForUser(e);return{twoWayMatches:s.filter(e=>"2-way"===e.type),threeWayMatches:s.filter(e=>"3-way"===e.type)}}catch(s){return{twoWayMatches:[],threeWayMatches:[],error:s instanceof Error?s.message:"Failed to get recommendations"}}})}calculateProposalFairness(e){const s={creditBalance:50,exchangeRate:0,timeCommitment:0,urgency:0,trustScore:0},r=e.exchangeRate,t=e.creditsOffered/e.creditsRequested,a=Math.abs(r-t)/r;s.exchangeRate=Math.max(0,25-25*a);const i=Math.abs(e.hoursOffered-e.hoursRequested);s.timeCommitment=Math.max(0,15-2*i);s.urgency={low:0,medium:-2,high:-5}[e.urgency];const o=Object.values(s).reduce((e,s)=>e+s,0);return{score:Math.max(0,Math.min(100,o)),factors:s}}sendProposalNotification(e,r){return s(this,null,function*(){})}convertTradeToProposal(e){return s(this,null,function*(){return{id:e.id,proposerId:e.proposer_id,providerId:e.provider_id,proposerServiceId:e.service_offered_id,providerServiceId:e.service_requested_id,hoursOffered:e.hours_offered,hoursRequested:e.hours_requested,creditsOffered:5*e.hours_offered,creditsRequested:5*e.hours_requested,exchangeRate:1,status:"cancelled"===e.status?"rejected":e.status,urgency:"medium",estimatedCompletionDays:7,deliverables:[],createdAt:new Date(e.created_at),updatedAt:new Date(e.updated_at),expiresAt:new Date(Date.now()+6048e5)}})}};var A,k;((s,r,t)=>{r in s?e(s,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[r]=t})(W,"symbol"!=typeof(A="instance")?A+"":A,k);const L=W.getInstance();function U(){const{user:e}=m(),[h,T]=r.useState([]),[E,W]=r.useState([]),[A,k]=r.useState({twoWayMatches:[],threeWayMatches:[]}),[U,Y]=r.useState(!0),[z,H]=r.useState(null),[B,$]=r.useState(!1),[K,V]=r.useState(""),[G,J]=r.useState("");r.useEffect(()=>{e&&(Q(),X())},[e]);const Q=()=>s(this,null,function*(){if(e)try{Y(!0);const{sent:s,received:r,error:t}=yield L.getUserProposals(e.id);t?p({variant:"destructive",title:"Error",description:t}):(T(s),W(r))}catch(s){}finally{Y(!1)}}),X=()=>s(this,null,function*(){if(e)try{const s=yield L.getTradeRecommendations(e.id);k(s)}catch(s){}}),Z=r=>s(this,null,function*(){if(e)try{const{success:s,error:t}=yield L.acceptProposal(r,e.id);s?(p({title:"Proposal Accepted! 🎉",description:"The trade has started. Check your active trades for next steps."}),Q()):p({variant:"destructive",title:"Error",description:t})}catch(s){}}),ee=r=>s(this,null,function*(){if(e)try{const{success:s,error:t}=yield L.rejectProposal(r,e.id);s?(p({title:"Proposal Rejected",description:"The proposal has been declined."}),Q()):p({variant:"destructive",title:"Error",description:t})}catch(s){}}),se=({proposal:e,isSent:s=!1})=>{const r=L.calculateProposalFairness(e);return s?e.providerId:e.proposerId,t.jsxs(f,{className:"mb-4",children:[t.jsx(v,{children:t.jsxs("div",{className:"flex items-start justify-between",children:[t.jsxs("div",{children:[t.jsxs(j,{className:"text-lg",children:[s?"Requested:":"Offering:"," ",e.hoursRequested,"h"]}),t.jsxs(g,{children:[s?"From":"To"," User • ",F(e.createdAt)," ago"]})]}),(h=e.status,t.jsx(N,{variant:{pending:"outline",accepted:"default",rejected:"destructive",counter_offered:"secondary"}[h]||"outline",className:{pending:"text-yellow-600",accepted:"text-green-600",rejected:"text-red-600",counter_offered:"text-blue-600"}[h],children:h.replace("_"," ").toUpperCase()}))]})}),t.jsxs(x,{className:"space-y-4",children:[t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsxs("h4",{className:"font-medium flex items-center gap-2",children:[t.jsx(a,{className:"w-4 h-4"}),s?"You Offer":"They Want"]}),t.jsxs("div",{className:"bg-muted p-3 rounded-lg",children:[t.jsxs("div",{className:"font-semibold",children:[e.hoursOffered," hours"]}),t.jsxs("div",{className:"text-sm text-muted-foreground",children:[e.creditsOffered," credits"]}),t.jsxs("div",{className:"text-xs",children:["≈₦",(1e3*e.creditsOffered).toLocaleString()]})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("h4",{className:"font-medium flex items-center gap-2",children:[t.jsx(i,{className:"w-4 h-4"}),s?"You Want":"They Offer"]}),t.jsxs("div",{className:"bg-muted p-3 rounded-lg",children:[t.jsxs("div",{className:"font-semibold",children:[e.hoursRequested," hours"]}),t.jsxs("div",{className:"text-sm text-muted-foreground",children:[e.creditsRequested," credits"]}),t.jsxs("div",{className:"text-xs",children:["≈₦",(1e3*e.creditsRequested).toLocaleString()]})]})]})]}),t.jsxs("div",{className:"flex items-center justify-between text-sm",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(o,{className:"w-4 h-4"}),t.jsx("span",{children:"Fairness Score:"}),t.jsxs("span",{className:"font-bold "+(u=r.score,u>=80?"text-green-600":u>=60?"text-yellow-600":"text-red-600"),children:[r.score,"%"]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(c,{className:"w-4 h-4"}),t.jsxs("span",{children:[e.estimatedCompletionDays," days estimated"]})]})]}),e.message&&t.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3",children:t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx(n,{className:"w-4 h-4 mt-0.5 text-blue-600"}),t.jsx("p",{className:"text-sm text-blue-800",children:e.message})]})}),!s&&"pending"===e.status&&t.jsxs("div",{className:"flex gap-2",children:[t.jsxs(y,{size:"sm",onClick:()=>Z(e.id),className:"flex-1",children:[t.jsx(d,{className:"w-4 h-4 mr-2"}),"Accept"]}),t.jsx(y,{size:"sm",variant:"outline",onClick:()=>{H(e),$(!0)},className:"flex-1",children:"Counter-Offer"}),t.jsx(y,{size:"sm",variant:"outline",onClick:()=>ee(e.id),children:t.jsx(l,{className:"w-4 h-4"})})]})]})]});var u,h};return U?t.jsx(u,{children:t.jsx("div",{className:"flex items-center justify-center min-h-96",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-pulse text-4xl mb-4",children:"🔄"}),t.jsx("p",{children:"Loading your trade proposals..."})]})})}):t.jsxs(u,{children:[t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"text-center space-y-2",children:[t.jsx("h1",{className:"text-3xl font-brand",children:"Trade Proposals"}),t.jsx("p",{className:"text-muted-foreground",children:"Manage your trade offers and discover new opportunities"})]}),t.jsxs(_,{defaultValue:"received",className:"w-full",children:[t.jsxs(w,{className:"grid w-full grid-cols-3",children:[t.jsxs(b,{value:"received",children:["Received (",E.length,")"]}),t.jsxs(b,{value:"sent",children:["Sent (",h.length,")"]}),t.jsxs(b,{value:"recommendations",children:["Suggestions (",A.twoWayMatches.length+A.threeWayMatches.length,")"]})]}),t.jsx(q,{value:"received",className:"space-y-4",children:0===E.length?t.jsx(f,{children:t.jsxs(x,{className:"p-8 text-center",children:[t.jsx("div",{className:"text-4xl mb-4",children:"📥"}),t.jsx("h3",{className:"font-semibold mb-2",children:"No proposals yet"}),t.jsx("p",{className:"text-muted-foreground",children:"When other users want to trade with you, their proposals will appear here."})]})}):E.map(e=>t.jsx(se,{proposal:e},e.id))}),t.jsx(q,{value:"sent",className:"space-y-4",children:0===h.length?t.jsx(f,{children:t.jsxs(x,{className:"p-8 text-center",children:[t.jsx("div",{className:"text-4xl mb-4",children:"📤"}),t.jsx("h3",{className:"font-semibold mb-2",children:"No sent proposals"}),t.jsx("p",{className:"text-muted-foreground",children:"Your outgoing trade proposals will appear here."})]})}):h.map(e=>t.jsx(se,{proposal:e,isSent:!0},e.id))}),t.jsx(q,{value:"recommendations",className:"space-y-4",children:t.jsxs(f,{children:[t.jsxs(v,{children:[t.jsx(j,{children:"🎯 Perfect Matches for You"}),t.jsx(g,{children:"Our AI found these trade opportunities based on your services and needs"})]}),t.jsx(x,{children:0===A.twoWayMatches.length&&0===A.threeWayMatches.length?t.jsxs("div",{className:"text-center p-8",children:[t.jsx("div",{className:"text-4xl mb-4",children:"🔍"}),t.jsx("p",{className:"text-muted-foreground",children:"No matches yet. Add more services to increase your match potential!"})]}):t.jsx("div",{className:"space-y-4",children:t.jsx("p",{className:"text-sm text-blue-600",children:"💡 These are high-quality matches where everyone saves money by trading time instead of paying cash!"})})})]})})]})]}),t.jsx(O,{open:B,onOpenChange:$,children:t.jsxs(S,{children:[t.jsxs(C,{children:[t.jsx(R,{children:"Make a Counter-Offer"}),t.jsx(M,{children:"Propose different terms for this trade"})]}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-medium",children:"Hours you're willing to offer:"}),t.jsx(D,{type:"number",placeholder:"e.g., 8",value:K,onChange:e=>V(e.target.value)})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-medium",children:"Message (optional):"}),t.jsx(P,{placeholder:"Explain why you're making this counter-offer...",value:G,onChange:e=>J(e.target.value)})]})]}),t.jsxs(I,{children:[t.jsx(y,{variant:"outline",onClick:()=>$(!1),children:"Cancel"}),t.jsx(y,{onClick:()=>s(this,null,function*(){if(z&&e&&K)try{const{success:s,error:r}=yield L.createCounterOffer(z.id,e.id,{originalProposalId:z.id,newHoursOffered:parseFloat(K),newMessage:G});s?(p({title:"Counter-Offer Sent",description:"Your counter-offer has been sent to the other party."}),$(!1),V(""),J(""),Q()):p({variant:"destructive",title:"Error",description:r})}catch(s){}}),disabled:!K,children:"Send Counter-Offer"})]})]})})]})}export{U as default};
